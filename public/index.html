<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carousel Link</title>
  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#0b0f13; color:#eee; }
    header { padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    .wrap { display:grid; place-items:center; height: calc(100vh - 60px); position: relative; }
    img {
      width: 100vw;
      height: auto;
      max-width: 100vw;
      max-height: 100vh;
      border-radius: 0;
      box-shadow: none;
      background: #111;
      display: block;
      margin: 0 auto;
      object-fit: contain;
    }
    .pill { font-size:12px; opacity:.7 }
    .controls { display:flex; gap:8px; }
    button { background:#1e2836; color:#d2f7d0; border:1px solid #243246; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    
    /* Dashboard info overlay */
    .dashboard-info {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.5);
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 14px;
      opacity: 0.8;
      z-index: 100;
      transition: opacity 0.3s;
    }
    
    .dashboard-info:hover {
      opacity: 1;
    }
    
    /* Pantalla de carga */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #0b0f13;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: #eee;
    }
    
    .loading-text {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid #1e2836;
      border-top: 3px solid #d2f7d0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .dashboard-count {
      margin-top: 20px;
      font-size: 16px;
      opacity: 0.7;
      text-align: center;
    }
    
    /* Estado del servidor */
    .server-status {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 10px;
      font-size: 12px;
      opacity: 0.5;
      z-index: 10;
    }
    
    .server-status:hover {
      opacity: 1;
    }
    
    .hidden { display: none !important; }
    
    /* Error message */
    .error-message {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(220,53,69,0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 80%;
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .error-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .reconnecting {
      color: #ffc107;
    }
  </style>
</head>
<body>
  <!-- Pantalla de carga inicial -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-text">üîÑ Cargando Dashboards...</div>
    <div class="spinner"></div>
    <div id="progress-info" class="dashboard-count">
      Capturando screenshots de los dashboards<br>
      <span id="progress-text">Iniciando...</span>
    </div>
  </div>
  
  <!-- Informaci√≥n de dashboard actual -->
  <div id="dashboard-info" class="dashboard-info hidden">
    Dashboard: <span id="current-name">-</span> (<span id="current-index">0</span>/<span id="total-count">0</span>)
    <br>
    √öltima actualizaci√≥n: <span id="last-updated">-</span>
  </div>
  
  <!-- Estado del servidor -->
  <div id="server-status" class="server-status hidden">
    Server: <span id="server-pid">-</span> | Uptime: <span id="server-uptime">-</span>s
  </div>
  
  <!-- Contenedor principal -->
  <div class="wrap">
    <img id="frame" alt="slide" />
  </div>
  
  <!-- Error message container -->
  <div id="error-container"></div>
  
  <script>
    // Variables globales
    let idx = 0, items = [], timer = null;
    let reconnectTimer = null;
    let failedRequests = 0;
    const MAX_FAILED_REQUESTS = 3;
    const RECONNECT_INTERVAL = 10000; // 10 segundos
    
    // Referencias DOM
    const loadingScreen = document.getElementById('loading-screen');
    const frame = document.getElementById('frame');
    const dashboardInfo = document.getElementById('dashboard-info');
    const currentName = document.getElementById('current-name');
    const currentIndex = document.getElementById('current-index');
    const totalCount = document.getElementById('total-count');
    const lastUpdated = document.getElementById('last-updated');
    const serverStatus = document.getElementById('server-status');
    const serverPid = document.getElementById('server-pid');
    const serverUptime = document.getElementById('server-uptime');
    const errorContainer = document.getElementById('error-container');

    // Funci√≥n para formatear fecha
    function formatDate(dateString) {
      if (!dateString) return 'Desconocido';
      
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMin = Math.floor(diffMs / 60000);
      
      if (diffMin < 1) {
        return 'Hace unos segundos';
      } else if (diffMin < 60) {
        return `Hace ${diffMin} minuto${diffMin > 1 ? 's' : ''}`;
      } else {
        const hours = Math.floor(diffMin / 60);
        if (hours < 24) {
          return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
        } else {
          const days = Math.floor(hours / 24);
          return `Hace ${days} d√≠a${days > 1 ? 's' : ''}`;
        }
      }
    }
    
    // Funci√≥n para mostrar errores
    function showError(message, isReconnecting = false) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      
      const titleSpan = document.createElement('div');
      titleSpan.className = 'error-title';
      titleSpan.textContent = isReconnecting ? 'Reconectando...' : 'Error';
      
      const messageSpan = document.createElement('div');
      messageSpan.textContent = message;
      if (isReconnecting) messageSpan.className = 'reconnecting';
      
      errorDiv.appendChild(titleSpan);
      errorDiv.appendChild(messageSpan);
      
      errorContainer.appendChild(errorDiv);
      
      // Auto-eliminar despu√©s de 10 segundos
      setTimeout(() => {
        if (errorDiv.parentNode) errorDiv.parentNode.removeChild(errorDiv);
      }, 10000);
    }

    // Cargar lista de dashboards del servidor
    async function loadList() {
      try {
        // Obtener lista de dashboards
        const res = await fetch('/api/list');
        if (!res.ok) throw new Error(`Error de servidor: ${res.status}`);
        
        const data = await res.json();
        
        // Reset contador de errores al tener √©xito
        failedRequests = 0;
        
        // Cancelar cualquier intento de reconexi√≥n en proceso
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }
        
        // Mantener dashboards en memoria y solo actualizar los que cambiaron
        if (items.length === 0) {
          // Primera carga - inicializar con todos los dashboards disponibles
          items = data.items.filter(x => x && x.available);
          console.log(`üìä Carga inicial: ${items.length} dashboards disponibles`);
        } else {
          // Actualizaci√≥n - mantener dashboards existentes y actualizar solo los disponibles
          const newItems = data.items.filter(x => x && x.available);
          
          // Para cada nuevo dashboard disponible, actualizar el correspondiente en la lista
          newItems.forEach(newItem => {
            const existingIndex = items.findIndex(item => item.id === newItem.id);
            if (existingIndex >= 0) {
              // Actualizar si ya existe
              items[existingIndex] = newItem;
              console.log(`üîÑ Dashboard actualizado: ${newItem.id}`);
            } else {
              // Agregar si es nuevo
              items.push(newItem);
              console.log(`‚ûï Nuevo dashboard agregado: ${newItem.id}`);
            }
          });
          
          // Contar dashboards actualizados
          console.log(`üìä Total actual: ${items.length} dashboards en memoria`);
        }
        
        // Actualizar informaci√≥n de progreso y servidor
        updateProgress(data);
        updateServerInfo(data.server);
        
        // CARRUSEL PROGRESIVO: Arrancar tan pronto como haya al menos 1 dashboard
        if (items.length > 0) {
          loadingScreen.classList.add('hidden');
          dashboardInfo.classList.remove('hidden');
          serverStatus.classList.remove('hidden');
          
          // Actualizar total de dashboards en el indicador
          totalCount.textContent = items.length;
          
          // Si es la primera vez que tenemos dashboards, arrancar carrusel
          if (!timer) {
            console.log(`üöÄ Iniciando carrusel con ${items.length} dashboard(s) disponible(s)`);
            show(0);
            play();
          }
        } else {
          // Si no hay im√°genes, mantiene la pantalla de carga
          loadingScreen.classList.remove('hidden');
          dashboardInfo.classList.add('hidden');
          serverStatus.classList.add('hidden');
        }
      } catch (error) {
        console.error('Error cargando lista:', error);
        
        // Incrementar contador de errores
        failedRequests++;
        
        // Mostrar error en la interfaz
        if (failedRequests <= MAX_FAILED_REQUESTS) {
          showError(`Error cargando dashboards: ${error.message}. Intento ${failedRequests}/${MAX_FAILED_REQUESTS}`);
        }
        
        // Si hay demasiados errores consecutivos, intentar reconectar
        if (failedRequests >= MAX_FAILED_REQUESTS && !reconnectTimer) {
          showError(`Intentando reconectar con el servidor...`, true);
          reconnectTimer = setTimeout(() => {
            loadList();
            reconnectTimer = null;
          }, RECONNECT_INTERVAL);
        }
      }
    }
    
    // Actualizar informaci√≥n de progreso
    function updateProgress(data) {
      const progressText = document.getElementById('progress-text');
      if (data.loading && data.total > 0) {
        const percentage = Math.round((data.progress / data.total) * 100);
        const successful = data.successful || 0;
        const failed = data.failed || 0;
        const available = data.available || 0;
        progressText.innerHTML = `
          Progreso: ${data.progress}/${data.total} dashboards (${percentage}%)<br>
          ‚úÖ Disponibles: ${available} | ‚ùå Fallidos: ${failed}<br>
          ${available > 0 ? 'üéØ Carrusel funcionando con dashboards disponibles' : '‚è≥ Esperando primer dashboard...'}
        `;
      } else if (!data.loading && data.total > 0) {
        const successful = data.successful || 0;
        const failed = data.failed || 0;
        progressText.innerHTML = `
          ‚úÖ Completado: ${successful} exitosos de ${data.total} dashboards<br>
          ${failed > 0 ? `‚ö†Ô∏è ${failed} dashboards fallaron` : 'üéâ Todos los dashboards capturados exitosamente'}
        `;
      } else {
        progressText.textContent = 'Iniciando captura de dashboards...';
      }
    }
    
    // Actualizar informaci√≥n del servidor
    function updateServerInfo(server) {
      if (!server) return;
      
      serverPid.textContent = server.pid || 'Desconocido';
      serverUptime.textContent = server.uptime ? Math.floor(server.uptime) : '-';
      
      // Si hay informaci√≥n de √∫ltimo estado, mostrarla
      if (server.lastState) {
        const ageMinutes = server.lastState.ageMinutes || 0;
        if (ageMinutes > 0) {
          serverStatus.title = `√öltima captura: hace ${ageMinutes} minutos (dashboard${server.lastState.lastIndex + 1})`;
        }
      }
    }

    // Mostrar un dashboard espec√≠fico
    function show(i) {
      if (!items.length) return;
      
      // Calcular √≠ndice correcto incluso si es negativo
      idx = (i + items.length) % items.length;
      const item = items[idx];
      
      if (!item) {
        console.error(`Error: No se encontr√≥ dashboard en √≠ndice ${idx}`);
        return;
      }
      
      console.log(`üîç Mostrando dashboard ${idx+1}/${items.length}: ${item.id}`);
      
      // Actualizar src de la imagen con cache-bust
      frame.src = item.img + `?t=${Date.now()}`;
      
      // Actualizar informaci√≥n del dashboard
      currentName.textContent = item.id;
      currentIndex.textContent = idx + 1;
      lastUpdated.textContent = formatDate(item.lastModified);
      
      // Log detallado para diagn√≥stico
      if (idx === items.length - 1) {
        console.log(`‚ö†Ô∏è √öltimo dashboard alcanzado (${idx+1}/${items.length}). Pr√≥ximo ser√° el primero.`);
      }
    }

    // Iniciar reproducci√≥n autom√°tica
    function play() {
      stop(); // Detener timer existente
      const s = 14000; // 14 segundos
      timer = setInterval(() => show(idx+1), s);
    }
    
    // Detener reproducci√≥n
    function stop() { 
      if (timer) clearInterval(timer); 
      timer = null; 
    }

    // Manejar errores de carga de im√°genes
    frame.addEventListener('error', function(e) {
      console.error('Error cargando imagen:', e);
      // Intentar avanzar al siguiente dashboard si hay error
      setTimeout(() => show(idx+1), 2000);
    });

    // Inicia carga inicial
    loadList();
    
    // CARRUSEL PROGRESIVO: Revisa cada 5 segundos durante la carga inicial
    const progressiveCheck = setInterval(() => {
      loadList().catch(err => console.error('Error en verificaci√≥n progresiva:', err));
      
      // Si ya tenemos suficientes dashboards, cambiar a revisi√≥n normal
      if (items.length >= 10) {
        console.log(`üéØ Suficientes dashboards cargados (${items.length}). Cambiando a revisi√≥n cada 60 segundos.`);
        clearInterval(progressiveCheck);
        
        // Despu√©s revisa cada 60 segundos normalmente
        setInterval(() => {
          loadList().catch(err => console.error('Error en verificaci√≥n peri√≥dica:', err));
        }, 60000); // Cada 60 segundos en modo normal
      }
    }, 5000); // Cada 5 segundos durante la carga inicial
    
    // MONITOREO ESPECIAL: Verificar cambios en el array de items
    setInterval(() => {
      console.log(`üìä Estado del carrusel: ${items.length} dashboards, √≠ndice actual=${idx+1}`);
    }, 120000); // Cada 2 minutos
  </script>
</body>
</html>
